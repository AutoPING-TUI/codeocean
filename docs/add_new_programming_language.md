# How to add a new programming language to Codeocean
## Overview
Adding a new programming language to Codeocean is done in three steps:
1. Create a Docker image that contains the necessary tools to compile, run, etc.
2. Create a Ruby file under lib/ that specifies the name of the testing framework, parses the output of the testing tools, and returns the number of tests, number of failed tests, and associated error messages. 
3. Create a new execution environment for the programming language in Codeoceans GUI.

### 1. Create the Docker image
The following Dockerfile is used as a starting point:
```dockerfile
FROM openhpi/docker_exec_phusion
LABEL description=''
LABEL run_command=''
LABEL test_command=''

# insert installation routines, environment variable adjustment, etc. here

# switch user
USER user
```

Each execution environment must be derived from `openhpi/docker_exec_phusion`. This image is based on `phusion/baseimage:master`, a Docker-optimized version of Ubuntu that provides, among other things, the [install_clean](https://github.com/phusion/baseimage-docker#overview) command for installing Ubuntu packages.  
At the end, the user needs to be switched so that he does not get elevated privileges in his container.

Specify the run and test command to be used for the programming language. Note that the run and test command are not automatically imported into Codeocean when you add a new Execution Environment.

Add the installation routines and customizations needed for the programming language.

Build with the following command:  
`docker build --no-cache -t openhpi/co_execenv_<language> .`  
where `<language>` is the corresponding programming language.

Select the image in Codeoceans graphical interface when creating a new Execution Environment. 

### 2. Create the Adapter
Create a file named my_adapter.rb and add the following content: 
```ruby
# frozen_string_literal: true

class MyAdapter < TestingFrameworkAdapter
    def self.framework_name
        # insert here what you want to call your test framework
    end

    def parse_output(output)
        # insert code here that parses the output generated by the testing tools
    end
end
```

Change the name of the file and class to match your programming language and testing tools.  
This class is a subclass of *`TestingFrameworkAdapter`*. Implement the methods *`self.framework_name`* and *`parse_output(output)`*:   
*`self.framework_name`* shall return the name of the testing framework as a string.  
*`parse_output`* gets a [hash object](https://ruby-doc.org/core-3.1.2/Hash.html) *`output`* with the following keys and data types of values:
- `file_role`: String
- `waiting_for_container_time`: Float
- `stdout`: String
- `stderr`: String
- `messages`: Array of hash objects with the keys `:cmd, :stream, :log, :timestamp`.
- `exit_code`: Integer
- `container_execution_time`: Float
- `status`: Symbol

*`parse_output`* shall return a [hash object](https://ruby-doc.org/core-3.1.2/Hash.html) with the following keys:
- `count`: Integer ( the number of executed tests)
- `failed`: Integer ( the number of failed tests)
- `error_messages`: Array of strings (the error messages of the failed tests.)

### 3. Create a new Execution Environment
1. In Codeoceans graphical interface select `Administration` > `Execution Environments` and click on `Add Execution Environment`.
2. Give it a name and default file type.
3. Select the Docker image you built above.
4. Copy and paste the run and test command from the Dockerfile into the corresponding fields.
5. Select the testing framework you defined above in *`self.framework_name`*.
6. It might be necessary to set the `Prewarming Pool Size` to > 0.
7. Make further adjustments if necessary and then click on `Create Execution Environment`.  
